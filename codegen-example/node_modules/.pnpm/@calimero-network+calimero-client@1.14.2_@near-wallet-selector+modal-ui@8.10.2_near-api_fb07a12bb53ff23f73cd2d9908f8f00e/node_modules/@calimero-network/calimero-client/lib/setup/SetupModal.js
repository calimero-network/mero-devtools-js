import React, { useEffect } from 'react';
import { useCallback, useState } from 'react';
import Spinner from '../components/loader/Spinner';
import { SetupErrorText, SetupFormContainer, SetupInputField, SetupInputGroup, SetupModalContainer, SetupModalContent, SetupModalOverlay, SetupSpinnerContainer, SetupSubmitButton, SetupTitle, } from './Components';
import { setAppEndpointKey } from '../storage';
const initialState = {
    url: '',
    errors: {
        url: '',
        applicationId: '',
    },
    isLoading: false,
};
const validateUrl = (url) => {
    try {
        new URL(url);
        return true;
    }
    catch {
        return false;
    }
};
/**
 * @component SetupModal
 * @description A modal for setting up the application.
 * @param {SetupModalProps} props - The props for the SetupModal component.
 * @returns {React.ReactNode} The SetupModal component.
 */
export const SetupModal = ({ setNodeServerUrl }) => {
    const [state, setState] = useState(initialState);
    const { url, errors, isLoading } = state;
    const updateState = (newState) => {
        setState((prev) => ({ ...prev, ...newState }));
    };
    const updateError = (field, message) => {
        setState((prev) => ({
            ...prev,
            errors: {
                ...prev.errors,
                [field]: message,
            },
        }));
    };
    const handleUrlChange = (value) => {
        updateState({
            url: value,
            errors: {
                ...state.errors,
                url: '',
            },
        });
    };
    const handleSubmit = useCallback(async () => {
        if (!url)
            return;
        if (!validateUrl(url)) {
            updateError('url', 'Connection failed. Please check if node url is correct.');
            return;
        }
        updateState({ isLoading: true });
        setAppEndpointKey(url);
        setNodeServerUrl(url);
    }, [url, setNodeServerUrl]);
    const onFormSubmit = (e) => {
        e.preventDefault();
        if (!isSubmitDisabled) {
            handleSubmit();
        }
    };
    const isSubmitDisabled = !url || Boolean(errors.url);
    useEffect(() => {
        const fragment = window.location.hash.substring(1);
        const fragmentParams = new URLSearchParams(fragment);
        const nodeUrl = fragmentParams.get('node_url');
        if (nodeUrl) {
            handleUrlChange(decodeURIComponent(nodeUrl));
            fragmentParams.delete('node_url');
            const newFragment = fragmentParams.toString();
            const newUrl = window.location.pathname +
                window.location.search +
                (newFragment ? `#${newFragment}` : '');
            window.history.replaceState({}, '', newUrl);
        }
    }, []);
    return (React.createElement(SetupModalOverlay, null,
        React.createElement(SetupModalContainer, null,
            React.createElement(SetupModalContent, null,
                React.createElement(SetupFormContainer, null,
                    React.createElement(SetupTitle, null, "Connect to Calimero Node"),
                    isLoading ? (React.createElement(SetupSpinnerContainer, null,
                        React.createElement(Spinner, null))) : (React.createElement("form", { onSubmit: onFormSubmit },
                        React.createElement(SetupInputGroup, null,
                            React.createElement(SetupInputField, { type: "text", placeholder: "Node URL", inputMode: "url", value: url, onChange: (e) => handleUrlChange(e.target.value), "aria-invalid": !!errors.url, "aria-describedby": "urlError" }),
                            React.createElement(SetupErrorText, null, errors.url),
                            React.createElement(SetupSubmitButton, { type: "submit", disabled: isSubmitDisabled },
                                React.createElement("span", null, "Continue"))))))))));
};
