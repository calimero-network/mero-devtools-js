import React, { useEffect, useState, useCallback } from 'react';
import { getApplicationId } from '../storage';
import { apiClient } from '../api';
import Spinner from '../components/loader/Spinner';
import { DeleteIcon } from '../components';
import { Button, DropdownSelector, ErrorMessage, FlexContainer, Heading2, Heading3, ListItem, Paragraph, ScrollableList, } from './Components';
export const CreateContext = () => {
    const applicationId = getApplicationId();
    const [contexts, setContexts] = useState([]);
    const [selectedProtocol, setSelectedProtocol] = useState('near');
    const [error, setError] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isDeleting, setIsDeleting] = useState(false);
    const fetchAvailableContexts = useCallback(async () => {
        const fetchContextsResponse = await apiClient.node().getContexts();
        const contexts = fetchContextsResponse.data?.contexts.filter((context) => context.applicationId === applicationId) ?? [];
        setContexts(contexts);
    }, [applicationId]);
    useEffect(() => {
        fetchAvailableContexts();
    }, [applicationId, fetchAvailableContexts]);
    const handleCreateContext = async () => {
        setError(null);
        setIsLoading(true);
        const fetchData = await apiClient
            .node()
            .createContext(applicationId, '', selectedProtocol);
        if (fetchData.error) {
            setError(fetchData.error.message);
        }
        else {
            await fetchAvailableContexts();
        }
        setIsLoading(false);
    };
    const handleDeleteContext = async (contextId) => {
        setIsDeleting(true);
        const fetchData = await apiClient.node().deleteContext(contextId);
        if (fetchData.error) {
            setError(fetchData.error.message);
        }
        else {
            await fetchAvailableContexts();
        }
        setIsDeleting(false);
    };
    return (React.createElement("div", { className: "create-tab" },
        React.createElement(Heading2, null, "Create Context"),
        React.createElement(Paragraph, null,
            "Application ID: ",
            applicationId),
        React.createElement("label", null, "Choose Protocol:"),
        React.createElement(FlexContainer, null,
            React.createElement("div", null,
                React.createElement(DropdownSelector, { value: selectedProtocol, onChange: (e) => setSelectedProtocol(e.target.value) },
                    React.createElement("option", { value: "near" }, "NEAR"),
                    React.createElement("option", { value: "ethereum" }, "Ethereum"),
                    React.createElement("option", { value: "starknet" }, "Starknet"),
                    React.createElement("option", { value: "stellar" }, "Stellar"),
                    React.createElement("option", { value: "icp" }, "ICP"))),
            React.createElement(Button, { disabled: isLoading, onClick: handleCreateContext, className: "button-rounded", style: { width: '177px' } }, isLoading ? React.createElement(Spinner, null) : 'Create New Context')),
        error && React.createElement(ErrorMessage, null, error),
        React.createElement(Heading3, null, "Existing Contexts"),
        React.createElement(ScrollableList, null, contexts.map((context, index) => (React.createElement(ListItem, { key: index },
            React.createElement("span", null,
                index + 1,
                ". ",
                context.id),
            isDeleting ? (React.createElement(Spinner, null)) : (React.createElement(DeleteIcon, { onClick: () => handleDeleteContext(context.id) }))))))));
};
