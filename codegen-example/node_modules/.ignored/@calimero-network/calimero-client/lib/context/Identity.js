import React, { useEffect, useState } from 'react';
import { getApplicationId } from '../storage';
import { apiClient } from '../api';
import Spinner from '../components/loader/Spinner';
import { Button, ContextSelector, DeleteIcon, DropdownSelector, ErrorMessage, FlexContainer, Heading2, IdentityContainer, ListItem, Paragraph, ScrollableList, } from './Components';
const NEW_IDENTITY_KEY = 'new-identity';
export const Identity = () => {
    const applicationId = getApplicationId();
    const [identities, setIdentities] = useState([]);
    const [contexts, setContexts] = useState([]);
    const [selectedContext, setSelectedContext] = useState(null);
    const [contextLoading, setContextLoading] = useState(true);
    const [identityLoading, setIdentityLoading] = useState(true);
    const [error, setError] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [newIdentity, setNewIdentity] = useState(null);
    const fetchAvailableContexts = async () => {
        setContextLoading(true);
        const fetchContextsResponse = await apiClient.node().getContexts();
        const contexts = fetchContextsResponse.data?.contexts.filter((context) => context.applicationId === applicationId) ?? [];
        setContexts(contexts);
        setSelectedContext(contexts[0]);
        setContextLoading(false);
    };
    useEffect(() => {
        fetchAvailableContexts();
    }, [applicationId]);
    const fetchContextIdentities = async () => {
        if (!selectedContext?.id)
            return;
        setIdentityLoading(true);
        const fetchContextIdentitiesResponse = await apiClient.node().fetchContextIdentities(selectedContext.id);
        if (fetchContextIdentitiesResponse.error) {
            setError(fetchContextIdentitiesResponse.error.message);
        }
        else {
            setIdentities(fetchContextIdentitiesResponse.data.identities);
        }
        setIdentityLoading(false);
    };
    useEffect(() => {
        if (selectedContext) {
            fetchContextIdentities();
        }
    }, [selectedContext]);
    const handleCreateIdentity = async () => {
        setError(null);
        setIsLoading(true);
        const fetchData = await apiClient
            .node()
            .createNewIdentity();
        if (fetchData.error) {
            setError(fetchData.error.message);
        }
        else {
            setNewIdentity(fetchData.data);
        }
        setIsLoading(false);
    };
    useEffect(() => {
        if (newIdentity) {
            localStorage.setItem(NEW_IDENTITY_KEY, JSON.stringify(newIdentity));
        }
        else {
            const newIdentity = localStorage.getItem(NEW_IDENTITY_KEY);
            if (newIdentity) {
                setNewIdentity(JSON.parse(newIdentity));
            }
        }
    }, [newIdentity]);
    const deleteIdentity = () => {
        localStorage.removeItem(NEW_IDENTITY_KEY);
        setNewIdentity(null);
    };
    return (React.createElement("div", { className: "identity-tab" },
        React.createElement(FlexContainer, null,
            React.createElement("div", null,
                React.createElement(Heading2, null, "Identities"),
                React.createElement(Button, { onClick: handleCreateIdentity, className: "button-rounded", disabled: isLoading }, isLoading ? React.createElement(Spinner, null) : 'Create New Identity')),
            newIdentity && (React.createElement(IdentityContainer, null,
                React.createElement("label", null, "New Identity"),
                React.createElement(Paragraph, { className: "text-sm" },
                    "Public Key: ",
                    React.createElement("br", null),
                    newIdentity?.publicKey),
                React.createElement(Paragraph, { className: "text-sm" },
                    "Private Key: ",
                    React.createElement("br", null),
                    newIdentity?.privateKey),
                React.createElement(DeleteIcon, { onClick: deleteIdentity }, "x")))),
        error && React.createElement(ErrorMessage, null, error),
        React.createElement(ContextSelector, null,
            React.createElement("label", null, "Select Context:"),
            contextLoading ? (React.createElement("div", null, "Loading contexts...")) : (React.createElement(DropdownSelector, { id: "context-select", className: "dropdown-selector", value: selectedContext?.id || '', onChange: (e) => {
                    const selected = contexts?.find((context) => context.id === e.target.value);
                    setSelectedContext(selected || null);
                } }, contexts?.map((context) => (React.createElement("option", { key: context.id, value: context.id }, context.id)))))),
        React.createElement("label", null, "Available Identities:"),
        React.createElement(ScrollableList, null, identityLoading ? (React.createElement("div", null, "Loading identities...")) : (identities.length > 0 &&
            identities.map((identity, index) => (React.createElement(ListItem, { key: index },
                React.createElement("span", null,
                    index + 1,
                    ". ",
                    identity))))))));
};
