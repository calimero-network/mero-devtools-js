import React, { useEffect, useState } from 'react';
import Spinner from '../components/loader/Spinner';
import { apiClient } from '../api';
import { getApplicationId } from '../storage';
import { Button, ContextSelector, DropdownSelector, ErrorMessage, FormGroup, FormInput, Heading2, Paragraph, SuccessMessage, } from './Components';
export const InviteContext = () => {
    const applicationId = getApplicationId();
    const [contextId, setContextId] = useState('');
    const [invitatorKey, setInvitatorKey] = useState('');
    const [inviteeKey, setInviteeKey] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const [invitation, setInvitation] = useState(null);
    const [contexts, setContexts] = useState([]);
    const [contextLoading, setContextLoading] = useState(false);
    const fetchAvailableContexts = async () => {
        setContextLoading(true);
        const fetchContextsResponse = await apiClient.node().getContexts();
        const contexts = fetchContextsResponse.data?.contexts.filter((context) => context.applicationId === applicationId) ?? [];
        setContexts(contexts);
        setContextId(contexts[0].id);
        setContextLoading(false);
    };
    useEffect(() => {
        fetchAvailableContexts();
    }, [applicationId]);
    const handleInviteSubmit = async (e) => {
        e.preventDefault();
        setError(null);
        setInvitation(null);
        setIsLoading(true);
        const response = await apiClient
            .node()
            .contextInvite(contextId, invitatorKey, inviteeKey);
        if (response.error) {
            setError(response.error.message);
        }
        else {
            if (response.data == null) {
                setError('Failed to invite to context.');
                setIsLoading(false);
                return;
            }
            setInvitation(response.data);
        }
        setIsLoading(false);
    };
    return (React.createElement("div", { className: "invite-tab" },
        React.createElement(Heading2, null, "Invite to Context"),
        React.createElement(Paragraph, null, "Fill in the details to create an invitation"),
        React.createElement("form", { onSubmit: handleInviteSubmit },
            React.createElement(FormGroup, null,
                React.createElement(ContextSelector, null,
                    React.createElement("label", null, "Select Context:"),
                    contextLoading ? (React.createElement("div", null, "Loading contexts...")) : (React.createElement(DropdownSelector, { id: "context-select", value: contextId || '', onChange: (e) => {
                            const selected = contexts?.find((context) => context.id === e.target.value);
                            setContextId(selected.id || '');
                        } }, contexts?.map((context) => (React.createElement("option", { key: context.id, value: context.id }, context.id))))))),
            React.createElement(FormGroup, null,
                React.createElement(FormInput, { type: "text", value: invitatorKey, onChange: (e) => setInvitatorKey(e.target.value), placeholder: "Inviter Public Key" })),
            React.createElement(FormGroup, null,
                React.createElement(FormInput, { type: "text", value: inviteeKey, onChange: (e) => setInviteeKey(e.target.value), placeholder: "Invitee Public Key" })),
            error && React.createElement(ErrorMessage, null, error),
            invitation && (React.createElement(SuccessMessage, null,
                React.createElement(Paragraph, null, "Invitation created successfully"),
                React.createElement("div", null,
                    "invitation payload: ",
                    React.createElement("span", { className: "payload" }, invitation)))),
            React.createElement(Button, { type: "submit", className: "button-rounded button-size-md", disabled: isLoading || !invitatorKey || !inviteeKey }, isLoading ? React.createElement(Spinner, null) : 'Create Invitation'))));
};
